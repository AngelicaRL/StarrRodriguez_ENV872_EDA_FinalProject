---
title: "MP Analysis Iniciatives PDET"
author: "Angelica"
date: "2025-03-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("tidyverse")
#install.packages("here")
#install.packages("lubridate")
#install.packages("cowplot")
#install.packages("agricolae")
#install.packages("ggplot2")
#install.packages("dplyr")
#install.packages ("tidyr")
#install.packages ("stats")

library("tidyverse")
library("here")
library("lubridate")
library("cowplot")
library("agricolae")
library("ggplot2")
library("dplyr")
library("tidyr")
library("stats")
library(readxl)


setwd("/Users/christopherstarr/StarrRodriguez_ENV872_EDA_FinalProject")

#Data Wrangling
#Read in all the excel documents and give them clearere names

#2020
IDF_2020_raw <- read_excel("IDF Indice de  Desempeño Fiscal/Anexos Desempeño Fiscal 2020_Nueva Metodología.xlsx", 
    sheet = "Municipios 2020", skip = 6)
View(IDF_2020_raw)

#2021
IDF_2021_raw <- read_excel("IDF Indice de  Desempeño Fiscal/IDF_2021_Nueva_Metodologia.xlsx", 
    sheet = "Municipios 2021", skip = 6)
View(IDF_2021_raw)

#2022
IDF_2022_raw <- read_excel("IDF Indice de  Desempeño Fiscal/Resultados IDF-Nueva Metodología 2022.xlsx", 
    skip = 5)
View(IDF_2022_raw)

#2023
IDF_2023_raw <- read_excel("IDF Indice de  Desempeño Fiscal/ResultadosIDF_Nueva_MetodologIa_2023_Act.xlsx", 
    sheet = "Municipios 2023", skip = 6)
View(IDF_2023_raw)

# Standardize 2020 dataset
IDF_2020_std <- IDF_2020_raw %>%
  rename(
    "Código" = "Codigo DANE",
    "Categorías" = "Categoría Ley 617",
    "Ciudad capital" = "Capitales",
    "Endeudamiento (Total)" = "Endeudamiento Largo Plazo",
    "Calificación Endeudamiento Total" = "Calificación Endeudamiento Largo Plazo",
    "Capacidad de programación y recaudo de ingresos" = "Capacidad de Ejecución de Ingresos",
    "Calificación capacidad de programación y recaudo de Ingresos" = "Calificación Capacidad de Ejecución de Ingresos",
    "Bonificación Esfuerzo Propio" = "Bonificación Esfuerzo Porpio"
  )

# Standardize 2021 dataset
IDF_2021_std <- IDF_2021_raw %>%
  rename(
    "Código" = "Codigo DANE",
    "Categorías" = "Categoría Ley 617",
    "Ciudad capital" = "Capitales",
    "Endeudamiento (Total)" = "Endeudamiento Largo Plazo",
    "Calificación Endeudamiento Total" = "Calificación Endeudamiento Largo Plazo",
    "Capacidad de programación y recaudo de ingresos" = "Capacidad de Ejecución de Ingresos",
    "Calificación capacidad de programación y recaudo de Ingresos" = "Calificación Capacidad de Ejecución de Ingresos"
  )

# Standardize 2022 dataset
IDF_2022_std <- IDF_2022_raw %>%
  rename(
    "Calificación Capacidad de Ejecución de Inversión" = "Capacidad de Ejecución de Inversión *", 
    "Gestión" = "Resultados Gestión",
    "Calificación Gestión" = "Calificación Resultados Gestión"
  )

# Standardize 2023 dataset
IDF_2023_std <- IDF_2023_raw %>%
  rename(
    "Gestión" = "Resultados Gestión",
    "Calificación Gestión" = "Calificación Resultados Gestión"
  )

# For IDF_2021_std, swap the order using relocate
IDF_2021_std <- IDF_2021_std %>%
  relocate('Nuevo IDF (sin bonos)', .before = 'Nuevo IDF') 

# For IDF_2020_std, swap the order using relocate
IDF_2020_std <- IDF_2020_std %>%
  relocate('Nuevo IDF (sin bonos)', .before = 'Nuevo IDF') 

# Now add a year identifier column to each dataset
IDF_2020_std <- IDF_2020_std %>%
  mutate(Year = 2020) %>%
  # Move Year column to the front for better visibility
  select(Year, everything())

IDF_2021_std <- IDF_2021_std %>%
  mutate(Year = 2021) %>%
  select(Year, everything())

IDF_2022_std <- IDF_2022_std %>%
  mutate(Year = 2022) %>%
  select(Year, everything())

IDF_2023_std <- IDF_2023_std %>%
  mutate(Year = 2023) %>%
  select(Year, everything())

IDF_2020_std <- IDF_2020_std %>% select(-c("Código Departamento" , "Categoría Ruralidad","Cumplimiento conjunto Ley 617 de 2000" ))

IDF_2021_std <- IDF_2021_std %>% select(-c("Código Departamento" ,"Cumplimiento conjunto Ley 617 de 2000" ))

# Fix Ciudad capital in 2020 dataset (convert from text to numeric)
IDF_2020_std <- IDF_2020_std %>%
  mutate(`Ciudad capital` = ifelse(`Ciudad capital` == "si", 1, 0))

# Fix Ciudad capital in 2021 dataset (convert from text to numeric)
IDF_2021_std <- IDF_2021_std %>%
  mutate(`Ciudad capital` = as.numeric(`Ciudad capital`))

# Fix Ciudad capital in 2020 and 2021 datasets
IDF_2020_std$`Ciudad capital` <- as.numeric(ifelse(IDF_2020_std$`Ciudad capital` == "si", 1, 0))
IDF_2021_std$`Ciudad capital` <- as.numeric(IDF_2021_std$`Ciudad capital`)

# Fix numeric columns in 2020 dataset
IDF_2020_std$`Dependencia de las Transferencias` <- as.numeric(IDF_2020_std$`Dependencia de las Transferencias`)
IDF_2020_std$`Relevancia FBK fijo` <- as.numeric(IDF_2020_std$`Relevancia FBK fijo`)
IDF_2020_std$`Endeudamiento (Total)` <- as.numeric(IDF_2020_std$`Endeudamiento (Total)`)
IDF_2020_std$`Ahorro Corriente` <- as.numeric(IDF_2020_std$`Ahorro Corriente`)
IDF_2020_std$`Balance Primario` <- as.numeric(IDF_2020_std$`Balance Primario`)
IDF_2020_std$`Capacidad de programación y recaudo de ingresos` <- as.numeric(IDF_2020_std$`Capacidad de programación y recaudo de ingresos`)
IDF_2020_std$`Capacidad de Ejecución de Inversión` <- as.numeric(IDF_2020_std$`Capacidad de Ejecución de Inversión`)
IDF_2020_std$`Nuevo IDF (sin bonos)` <- as.numeric(IDF_2020_std$`Nuevo IDF (sin bonos)`)
IDF_2020_std$`Nuevo IDF` <- as.numeric(IDF_2020_std$`Nuevo IDF`)

# Fix numeric columns in 2021 dataset
IDF_2021_std$`Dependencia de las Transferencias` <- as.numeric(IDF_2021_std$`Dependencia de las Transferencias`)
IDF_2021_std$`Relevancia FBK fijo` <- as.numeric(IDF_2021_std$`Relevancia FBK fijo`)
IDF_2021_std$`Endeudamiento (Total)` <- as.numeric(IDF_2021_std$`Endeudamiento (Total)`)
IDF_2021_std$`Ahorro Corriente` <- as.numeric(IDF_2021_std$`Ahorro Corriente`)
IDF_2021_std$`Capacidad de Ejecución de Inversión` <- as.numeric(IDF_2021_std$`Capacidad de Ejecución de Inversión`)
IDF_2021_std$`Nuevo IDF (sin bonos)` <- as.numeric(IDF_2021_std$`Nuevo IDF (sin bonos)`)
IDF_2021_std$`Nuevo IDF` <- as.numeric(IDF_2021_std$`Nuevo IDF`)

# Fix numeric columns in 2023 dataset
IDF_2023_std$`Dependencia de las Transferencias` <- as.numeric(IDF_2023_std$`Dependencia de las Transferencias`)
IDF_2023_std$`Relevancia FBK fijo` <- as.numeric(IDF_2023_std$`Relevancia FBK fijo`)
IDF_2023_std$`Ahorro Corriente` <- as.numeric(IDF_2023_std$`Ahorro Corriente`)
IDF_2023_std$`Balance Primario` <- as.numeric(IDF_2023_std$`Balance Primario`)
IDF_2023_std$`Holgura` <- as.numeric(IDF_2023_std$`Holgura`)
IDF_2023_std$`Capacidad de programación y recaudo de ingresos` <- as.numeric(IDF_2023_std$`Capacidad de programación y recaudo de ingresos`)
IDF_2023_std$`Capacidad de Ejecución de Inversión` <- as.numeric(IDF_2023_std$`Capacidad de Ejecución de Inversión`)



#Verify Column Names
colnames(IDF_2020_std)
colnames(IDF_2021_std)
colnames(IDF_2022_std)
colnames(IDF_2023_std)

#Merge into one set for analysis
IDF_combined <- bind_rows(IDF_2020_std, IDF_2021_std, IDF_2022_std, IDF_2023_std)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
###Looking at the combined dataset
summary(IDF_combined)

# 1. Count total unique municipalities
total_unique_municipios <- IDF_combined %>%
  distinct(Municipio) %>%
  nrow()

# Display the count
cat("Total Unique Municipalities:", total_unique_municipios, "\n\n")

# 2. Count códigos per municipality
codigos_per_municipio <- IDF_combined %>%
  group_by(Municipio, Departamento) %>%
  summarize(
    Codigo_Count = n_distinct(Código, Year),
    .groups = "drop"
  ) %>%
  arrange(Departamento, Municipio)

# 3. Count Códigos per Departamento
codigos_per_departamento <- table(IDF_combined$Departamento)
sorted_departamentos <- sort(codigos_per_departamento, decreasing = TRUE)
print(sorted_departamentos)  # Show all departments by código count
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
# 2. Visualization: Scatterplot of IDF score by Category, colored by Department
# For better visualization, we'll select the top departments by municipality count
top_departments <- IDF_combined %>%
  distinct(Municipio, Departamento) %>%
  count(Departamento, sort = TRUE) %>%
  head(10) %>%
  pull(Departamento)

# Create the scatterplot
plot_data <- IDF_combined %>%
  filter(Departamento %in% top_departments) %>%
  # Use the most recent year for cleaner visualization
  filter(Year == max(Year))

# Create the plot
idf_scatter <- ggplot(plot_data, aes(x = `Nuevo IDF`, y = Categorías, color = Departamento)) +
  geom_jitter(alpha = 0.7, width = 0, height = 0.2) +
  labs(
    title = "IDF Scores by Municipality Category",
    subtitle = paste("Top", length(top_departments), "Departments by Municipality Count"),
    x = "Nuevo IDF Score",
    y = "Municipality Category",
    color = "Department"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 8)
  ) +
  guides(color = guide_legend(nrow = 2))

# Display the plot
print(idf_scatter)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
